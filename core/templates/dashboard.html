{% extends 'base.html' %}

{% block title %}Dashboard - Prestação de Contas{% endblock %}

{% block content %}
<h2 class="text-center mb-5 fw-bold text-dark">
  <i class="bi bi-clock-history me-2" aria-hidden="true"></i> Histórico de Ações
</h2>

<style>
.timeline { position: relative; }
.timeline-line{
  position:absolute; inset:0 auto 0 50%;
  transform: translateX(-50%);
  width:4px; background:#1f4aa8; border-radius:2px;
  pointer-events:none; z-index:1;
}
.timeline-row{ position:relative; }
.timeline-row .timeline-dot{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%,-50%);
  width:16px; height:16px; background:#fff;
  border:4px solid #1f4aa8; border-radius:50%;
  box-shadow:0 0 0 4px rgba(31,74,168,.15);
  z-index:2;
}

.timeline-list{
  margin:0;
  padding-left: 1.2rem; 
  list-style: disc inside;
}
.timeline-list li{
  margin: .25rem 0;
  line-height: 1.4;
}
.timeline-list .date{
  font-weight: 700;
}
.timeline-row{
  opacity:0; transform: translateY(40px);
  transition: opacity .6s ease, transform .6s ease;
}
.timeline-row.is-visible{
  opacity:1; transform: translateY(0);
}

@media (max-width: 767.98px){
  .timeline-line, .timeline-dot{ display:none; }
}

.card .dropdown-toggle:focus{
  outline: 2px solid #1f4aa8; outline-offset: 2px;
}
</style>

<div class="timeline position-relative">
  <span class="timeline-line" aria-hidden="true"></span>

  {% for conta in contas %}
    <div class="row g-4 align-items-stretch timeline-row position-relative" data-index="{{ forloop.counter0 }}">
      <span class="timeline-dot" aria-hidden="true"></span>

      {% if forloop.counter0|divisibleby:2 %}
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start gap-3 mb-2">
                <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                <div class="dropdown ms-auto">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                    <i class="bi bi-three-dots" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                  </ul>
                </div>
              </div>

              {% if conta.descricao %}
                <p class="text-muted mb-2 js-desc">{{ conta.descricao|safe }}</p>
              {% endif %}

              <small class="text-muted">
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-6 d-none d-md-block"></div>
      {% else %}
        <div class="col-md-6 d-none d-md-block"></div>
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start gap-3 mb-2">
                <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                <div class="dropdown ms-auto">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                    <i class="bi bi-three-dots" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                  </ul>
                </div>
              </div>

              {% if conta.descricao %}
                <p class="text-muted mb-2 js-desc">{{ conta.descricao|safe }}</p>
              {% endif %}

              <small class="text-muted">
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
              </small>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const descs = document.querySelectorAll('.js-desc');
  const dateRegex = /^(?:\d{1,2}\/\d{1,2}\/\d{2,4}|(?:\d{1,2}\s+de\s+[A-Za-zÀ-ÿ]+(?:\s+de)?\s+\d{4}))/i;

  descs.forEach(wrapper => {
    const existingList = wrapper.querySelector('ul, ol');
    if (existingList) {
      const ul = document.createElement('ul');
      ul.className = 'timeline-list';
      ul.setAttribute('role', 'list');

      existingList.querySelectorAll('li').forEach(li0 => {
        const li = document.createElement('li');
        li.innerHTML = li0.innerHTML; 
        ul.appendChild(li);
      });

      wrapper.replaceWith(ul);
      return;
    }

    const html = wrapper.innerHTML
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/p>\s*<p>/gi, '\n');
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const rawText = (temp.textContent || temp.innerText || '').trim();
    if (!rawText) { wrapper.remove(); return; }

    const normalized = rawText.replace(/[ \t]+/g, ' ');
    let parts = normalized
      .split(/\s*(?:\n+|[.;]|[•\-—–]|\*\s*)\s*/g)
      .map(s => s.trim())
      .filter(Boolean);

    if (parts.length <= 1) return;

    const ul = document.createElement('ul');
    ul.className = 'timeline-list';
    ul.setAttribute('role', 'list');

    parts.forEach(item => {
      const li = document.createElement('li');
      const m = item.match(dateRegex);

      if (m) {
        const dateSpan = document.createElement('strong');
        dateSpan.className = 'date';
        dateSpan.textContent = m[0];
        li.appendChild(dateSpan);

        const rest = item.slice(m[0].length).replace(/^[\s:\-–—,]+/, ' ');
        if (rest) li.appendChild(document.createTextNode(': ' + rest));
      } else {
        li.appendChild(document.createTextNode(item));
      }
      ul.appendChild(li);
    });

    wrapper.replaceWith(ul);
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const cards = document.querySelectorAll('.stats-card');
  cards.forEach((card, index) => {
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    card.style.transition = 'all 0.5s ease';
    setTimeout(() => {
      requestAnimationFrame(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      });
    }, index * 200);
  });

  
  const rows = document.querySelectorAll('.timeline-row');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target); 
      }
    });
  }, { threshold: 0.2 });

  rows.forEach(row => observer.observe(row));
});
</script>
{% endblock %}
{% endblock %}
