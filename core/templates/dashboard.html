{% extends 'base.html' %}

{% block title %}Dashboard - Prestação de Contas{% endblock %}

{% block content %}
<h2 class="text-center mb-5 fw-bold text-dark">
  <i class="bi bi-clock-history me-2" aria-hidden="true"></i> Histórico de Ações
</h2>

<style>
/* ===== Timeline ===== */
.timeline { position: relative; }
.timeline-line{
  position:absolute; inset:0 auto 0 50%;
  transform: translateX(-50%);
  width:4px; background:#1f4aa8; border-radius:2px;
  pointer-events:none; z-index:1;
}
.timeline-row{ position:relative; }
.timeline-row .timeline-dot{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%,-50%);
  width:16px; height:16px; background:#fff;
  border:4px solid #1f4aa8; border-radius:50%;
  box-shadow:0 0 0 4px rgba(31,74,168,.15);
  z-index:2;
}

/* Lista gerada do .js-desc */
.timeline-list{
  margin:0;
  padding-left: 1.2rem;   /* para bullets "inside" ficarem alinhados */
  list-style: disc inside;
}
.timeline-list li{
  margin: .25rem 0;
  line-height: 1.4;
}
.timeline-list .date{
  font-weight: 700;
}

/* Animações (entrada suave) */
.timeline-row{
  opacity:0; transform: translateY(40px);
  transition: opacity .6s ease, transform .6s ease;
}
.timeline-row.is-visible{
  opacity:1; transform: translateY(0);
}

/* Responsivo: remove linha/dot no mobile para evitar sobreposição */
@media (max-width: 767.98px){
  .timeline-line, .timeline-dot{ display:none; }
}

/* Acessibilidade de foco para itens clicáveis no card */
.card .dropdown-toggle:focus{
  outline: 2px solid #1f4aa8; outline-offset: 2px;
}
</style>

<div class="timeline position-relative">
  <span class="timeline-line" aria-hidden="true"></span>

  {% for conta in contas %}
    <div class="row g-4 align-items-stretch timeline-row position-relative" data-index="{{ forloop.counter0 }}">
      <span class="timeline-dot" aria-hidden="true"></span>

      {% if forloop.counter0|divisibleby:2 %}
        <!-- ÍMPAR: card à esquerda -->
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start gap-3 mb-2">
                <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                <div class="dropdown ms-auto">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                    <i class="bi bi-three-dots" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                  </ul>
                </div>
              </div>

              {% if conta.descricao %}
                <p class="text-muted mb-2 js-desc">{{ conta.descricao }}</p>
              {% endif %}

              <small class="text-muted">
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
              </small>
            </div>
          </div>
        </div>
        <div class="col-md-6 d-none d-md-block"></div>
      {% else %}
        <!-- PAR: card à direita -->
        <div class="col-md-6 d-none d-md-block"></div>
        <div class="col-md-6">
          <div class="card h-100 shadow-sm">
            <div class="card-body">
              <div class="d-flex align-items-start gap-3 mb-2">
                <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                <div class="dropdown ms-auto">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                    <i class="bi bi-three-dots" aria-hidden="true"></i>
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                    <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                  </ul>
                </div>
              </div>

              {% if conta.descricao %}
                <p class="text-muted mb-2 js-desc">{{ conta.descricao }}</p>
              {% endif %}

              <small class="text-muted">
                <i class="bi bi-calendar-event me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
              </small>
            </div>
          </div>
        </div>
      {% endif %}
    </div>
  {% endfor %}
</div>

{% block scripts %}
<script>
/**
 * Converte <p.js-desc> em <ul.timeline-list><li>...</li></ul>
 * Aceita: quebras de linha, ponto final, ponto-e-vírgula, bullets (• - — – *).
 * Realça datas no início (ex: "12/05/2024", "12 de Maio de 2024").
 */
document.addEventListener('DOMContentLoaded', function () {
  const descs = document.querySelectorAll('.js-desc');
  const dateRegex = /^(?:\d{1,2}\/\d{1,2}\/\d{2,4}|(?:\d{1,2}\s+de\s+[A-Za-zÀ-ÿ]+(?:\s+de)?\s+\d{4}))/i;

  descs.forEach(p => {
    const raw = (p.textContent || '').trim();
    if (!raw) return;

    // Normaliza espaços e separa itens
    const normalized = raw.replace(/\s+/g, ' ');
    let parts = normalized
      .split(/\s*(?:\n+|[.;]|[•\-—–]|\*\s*)\s*/g)
      .map(s => s.trim())
      .filter(Boolean);

    const ul = document.createElement('ul');
    ul.className = 'timeline-list';
    ul.setAttribute('role', 'list');

    parts.forEach(item => {
      const li = document.createElement('li');

      const m = item.match(dateRegex);
      if (m) {
        const dateSpan = document.createElement('strong');
        dateSpan.className = 'date';
        dateSpan.textContent = m[0];
        li.appendChild(dateSpan);

        const rest = item.slice(m[0].length).replace(/^[\s:\-–—,]+/, ' ');
        if (rest) li.appendChild(document.createTextNode(': ' + rest));
      } else {
        li.appendChild(document.createTextNode(item));
      }
      ul.appendChild(li);
    });

    p.replaceWith(ul);
  });
});
</script>

<script>
/**
 * Anima cards (.stats-card) em cascata e revela linhas da timeline ao entrar na viewport.
 * Corrige os seletores para usar .timeline-row (em vez de .timeline-item).
 */
document.addEventListener('DOMContentLoaded', function() {
  // Animação de stats-cards (se existirem na página)
  const cards = document.querySelectorAll('.stats-card');
  cards.forEach((card, index) => {
    // estado inicial
    card.style.opacity = '0';
    card.style.transform = 'translateY(30px)';
    card.style.transition = 'all 0.5s ease';

    // entrada em cascata
    setTimeout(() => {
      requestAnimationFrame(() => {
        card.style.opacity = '1';
        card.style.transform = 'translateY(0)';
      });
    }, index * 200);
  });

  // Revela as linhas da timeline
  const rows = document.querySelectorAll('.timeline-row');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target); // revela uma vez
      }
    });
  }, { threshold: 0.2 });

  rows.forEach(row => observer.observe(row));
});
</script>
{% endblock %}
{% endblock %}
