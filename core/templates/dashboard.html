{% extends 'base.html' %}

{% block title %}Dashboard - Portal de Transparência{% endblock %}

{% block content %}
<h2 class="text-center mb-4 fw-bold text-dark">
  <i class="bi bi-clock-history me-2" aria-hidden="true"></i> Histórico de Ações
</h2>

<div class="d-flex justify-content-center align-items-center text-center">
    <div class="justify-content-center align-items-center text-center">
    <a class="nav-link btn-new-account" href="{% url 'cadastrar_conta' %}">         
      <i class="bi bi-plus-circle me-2" aria-hidden="true"></i>         
      <span>Nova Conta</span>       
    </a>
  </div>

  <div class="text-center">
    {% if request.current_base %}
      <div class="small text-muted">
        <i class="bi bi-building me-1" aria-hidden="true"></i>
        Base atual: <strong>{{ request.current_base.nome }}</strong>
      </div>
    {% endif %}
  </div>

  <div class="d-flex align-items-center gap-2 ms-auto">
    {% if request.user.is_superuser or bases|length > 1 %}
    <form method="post" action="{% url 'switch_base' %}" class="d-flex align-items-center gap-2">
      {% csrf_token %}
      <label for="base_id" class="form-label mb-0 small text-muted">Trocar base:</label>
      <select id="base_id" name="base_id" class="form-select form-select-sm" onchange="this.form.submit()">
        {% for b in bases %}
          <option value="{{ b.id }}" {% if request.current_base and b.id == request.current_base.id %}selected{% endif %}>
            {{ b.nome }}
          </option>
        {% endfor %}
      </select>
    </form>
    {% endif %}
  </div>
</div>

<style>


.btn-new-account{
  display:inline-flex;
  align-items:center;
  gap:.5rem;
  padding:.6rem 1rem;
  border-radius:999px;
  font-weight:700;
  text-decoration:none!important;
  color:#fff!important;

  background: linear-gradient(135deg,#1e40af,#2563eb);
  box-shadow: 0 8px 20px rgba(37, 99, 235, .25);

  transition: transform .15s ease, box-shadow .2s ease, filter .2s ease;
  position:relative;
  overflow:hidden;
  border:0;
}

.btn-new-account::after{
  content:"";
  position:absolute;
  inset:0;
  background: radial-gradient(120px 50px at var(--x, 0%) var(--y, 0%), rgba(255,255,255,.18), transparent 60%);
  opacity:0;
  transition: opacity .2s ease;
  pointer-events:none;
}

.btn-new-account:hover{
  transform: translateY(-1px);
  box-shadow: 0 10px 24px rgba(37, 99, 235, .32);
  filter: brightness(1.03);
}
.btn-new-account:hover::after{ opacity:1; }

.btn-new-account:active{
  transform: translateY(0) scale(.98);
}

.btn-new-account:focus{
  outline: 0;
  box-shadow:
    0 0 0 3px rgba(255,255,255,.9),
    0 0 0 6px rgba(37,99,235,.55);
}

.btn-new-account .bi{
  display:inline-grid;
  place-items:center;
  width:26px; height:26px;
  border-radius:50%;
  background: rgba(255,255,255,.18);
  box-shadow: inset 0 0 0 1px rgba(255,255,255,.25);
  font-size:14px;
}

@media (max-width: 575.98px){
  .btn-new-account{ padding:.55rem .85rem; }
  .btn-new-account .bi{ width:24px; height:24px; }
}

.btn-new-account:hover{
  --x: 50%; --y: 50%;
}
.btn-new-account:hover{ cursor:pointer; }

.timeline { position: relative; }
.timeline-line{
  position:absolute; inset:0 auto 0 50%;
  transform: translateX(-50%);
  width:4px; background:#1f4aa8; border-radius:2px;
  pointer-events:none; z-index:1;
}
.timeline-row{ position:relative; }
.timeline-row .timeline-dot{
  position:absolute; left:50%; top:50%;
  transform: translate(-50%,-50%);
  width:16px; height:16px; background:#fff;
  border:4px solid #1f4aa8; border-radius:50%;
  box-shadow:0 0 0 4px rgba(31,74,168,.15);
  z-index:2;
}
.timeline-month {
  position: relative; text-align: center; margin: 2.25rem 0 1rem; z-index: 3;
}
.timeline-month .month-chip {
  display: inline-block; background: #eef2ff; color: #1f4aa8;
  border: 1px solid #dbe2f7; padding: .35rem .85rem; border-radius: 999px;
  font-weight: 700; text-transform: capitalize; box-shadow: 0 2px 6px rgba(31,74,168,.08);
  font-size: 1.35rem;
}
.timeline-date{
  width: 8.3%; position:absolute; top:50%;
  font-size:1.30em; font-weight:600; color:#1f4aa8;
  background:#fff; border:1px solid #dbe2f7;
  border-radius:999px; padding:2px 10px; box-shadow:0 2px 6px rgba(31,74,168,.08);
  line-height:1.2; white-space:nowrap; z-index:3;
}
.timeline-date.to-right{ left:calc(50% + 14px); transform:translate(0,-50%); text-align:left; }
.timeline-date.to-left{  left:calc(50% - 14px); transform:translate(-100%,-50%); text-align:right; }

.timeline-list{ margin:0; padding-left: 1.2rem; list-style: disc inside; }
.timeline-list li{ margin: .25rem 0; line-height: 1.4; }
.timeline-list .date{ font-weight: 700; }
.timeline-row{ opacity:0; transform: translateY(40px); transition: opacity .6s ease, transform .6s ease; }
.timeline-row.is-visible{ opacity:1; transform: translateY(0); }
@media (max-width: 767.98px){
  .timeline-line, .timeline-dot, .timeline-date{ display:none; }
}
.card .dropdown-toggle:focus{ outline: 2px solid #1f4aa8; outline-offset: 2px; }

.attachments { margin-top:.5rem; }
.attachments-header { display:flex; align-items:center; gap:.5rem; font-weight:600; color:#1f4aa8; margin-bottom:.35rem; }
.attachments-grid { display:flex; flex-wrap:wrap; gap:.5rem; }
.attachment-pill {
  display:flex; align-items:center; gap:.5rem;
  border:1px solid #dbe2f7; border-radius:999px; padding:.35rem .6rem; background:#fff; text-decoration:none;
}
.attachment-pill:hover { background:#f7f9ff; }
.attachment-thumb {
  width:36px; height:36px; border-radius:8px; overflow:hidden;
  display:flex; align-items:center; justify-content:center; border:1px solid #eef2ff; font-size:1.1rem;
}
.attachment-meta { font-size:.8rem; color:#6c757d; }
.badge-count { background:#1f4aa8; color:#fff; border-radius:999px; padding:.1rem .45rem; font-size:.75rem; }
</style>

<div class="timeline position-relative">
  {% if contas_grupos and contas_grupos|length %}
    <span class="timeline-line" aria-hidden="true"></span>

    {% for grupo in contas_grupos %}

      {# cards do mês #}
      {% for conta in grupo.contas %}
        <div class="row g-4 align-items-stretch timeline-row position-relative" data-index="{{ forloop.counter0 }}">
          <span class="timeline-dot p-2" aria-hidden="true"></span>

          {% if forloop.counter0|divisibleby:2 %}
            <span class="timeline-date to-right">{{ conta.data|date:"d/m/Y" }}</span>
          {% else %}
            <span class="timeline-date to-left">{{ conta.data|date:"d/m/Y" }}</span>
          {% endif %}

          {% if forloop.counter0|divisibleby:2 %}
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-start gap-3 mb-2">
                    <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                    <div class="dropdown ms-auto">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                        <i class="bi bi-three-dots" aria-hidden="true"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                        <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                      </ul>
                    </div>
                  </div>

                  {% if conta.descricao %}
                    <p class="text-muted mb-2 js-desc">{{ conta.descricao|safe }}</p>
                  {% endif %}

                  {% with n=conta.anexos.count %}
                    {% if n %}
                      <div class="attachments">
                        <div class="attachments-header">
                          <i class="bi bi-paperclip" aria-hidden="true"></i>
                          Anexos
                          {% if n > 1 %}<span class="badge-count" aria-label="{{ n }} anexos">{{ n }}</span>{% endif %}
                        </div>
                        <div class="attachments-grid">
                          {% for an in conta.anexos.all %}
                            {% with nome=an.nome_original|default:an.filename ct=an.content_type|default_if_none:"" %}
                            <a href="{% url 'baixar_anexo' an.pk %}" class="attachment-pill" target="_blank" rel="noopener noreferrer">
                              <span class="attachment-thumb">
                                {% if ct and ct|slice:":6" == "image/" %}
                                  <i class="bi bi-file-image" aria-hidden="true"></i>
                                {% elif ct == "application/pdf" %}
                                  <i class="bi bi-filetype-pdf" aria-hidden="true"></i>
                                {% else %}
                                  <i class="bi bi-file-earmark" aria-hidden="true"></i>
                                {% endif %}
                              </span>
                              <span>
                                <div class="fw-semibold text-truncate" style="max-width:220px">{{ nome }}</div>
                                <div class="attachment-meta">
                                  {% if an.tamanho %}{{ an.tamanho|filesizeformat }} · {% endif %}
                                  {{ an.criado_em|date:"d/m/Y H:i" }}
                                </div>
                              </span>
                            </a>
                            {% endwith %}
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  {% endwith %}

                  <small class="text-muted d-block mt-2">
                    <i class="bi bi-building me-1" aria-hidden="true"></i>{{ conta.base.nome|default:"(sem base)" }}
                    &middot;
                    <i class="bi bi-calendar-event ms-2 me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
                  </small>
                </div>
              </div>
            </div>
            <div class="col-md-6 d-none d-md-block"></div>
          {% else %}
            <div class="col-md-6 d-none d-md-block"></div>
            <div class="col-md-6">
              <div class="card h-100 shadow-sm">
                <div class="card-body">
                  <div class="d-flex align-items-start gap-3 mb-2">
                    <h5 class="card-title mb-0 fw-bold flex-grow-1">{{ conta.titulo }}</h5>
                    <div class="dropdown ms-auto">
                      <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Ações">
                        <i class="bi bi-three-dots" aria-hidden="true"></i>
                      </button>
                      <ul class="dropdown-menu dropdown-menu-end">
                        <li><a class="dropdown-item" href="{% url 'editar_conta' conta.pk %}"><i class="bi bi-pencil me-2" aria-hidden="true"></i>Editar</a></li>
                        <li><a class="dropdown-item text-danger" href="{% url 'excluir_conta' conta.pk %}"><i class="bi bi-trash me-2" aria-hidden="true"></i>Excluir</a></li>
                      </ul>
                    </div>
                  </div>

                  {% if conta.descricao %}
                    <p class="text-muted mb-2 js-desc">{{ conta.descricao|safe }}</p>
                  {% endif %}

                  {% with n=conta.anexos.count %}
                    {% if n %}
                      <div class="attachments">
                        <div class="attachments-header">
                          <i class="bi bi-paperclip" aria-hidden="true"></i>
                          Anexos
                          {% if n > 1 %}<span class="badge-count" aria-label="{{ n }} anexos">{{ n }}</span>{% endif %}
                        </div>
                        <div class="attachments-grid">
                          {% for an in conta.anexos.all %}
                            {% with nome=an.nome_original|default:an.filename ct=an.content_type|default_if_none:"" %}
                            <a href="{% url 'baixar_anexo' an.pk %}" class="attachment-pill" target="_blank" rel="noopener noreferrer">
                              <span class="attachment-thumb">
                                {% if ct and ct|slice:":6" == "image/" %}
                                  <i class="bi bi-file-image" aria-hidden="true"></i>
                                {% elif ct == "application/pdf" %}
                                  <i class="bi bi-filetype-pdf" aria-hidden="true"></i>
                                {% else %}
                                  <i class="bi bi-file-earmark" aria-hidden="true"></i>
                                {% endif %}
                              </span>
                              <span>
                                <div class="fw-semibold text-truncate" style="max-width:220px">{{ nome }}</div>
                                <div class="attachment-meta">
                                  {% if an.tamanho %}{{ an.tamanho|filesizeformat }} · {% endif %}
                                  {{ an.criado_em|date:"d/m/Y H:i" }}
                                </div>
                              </span>
                            </a>
                            {% endwith %}
                          {% endfor %}
                        </div>
                      </div>
                    {% endif %}
                  {% endwith %}

                  <small class="text-muted d-block mt-2">
                    <i class="bi bi-building me-1" aria-hidden="true"></i>{{ conta.base.nome|default:"(sem base)" }}
                    &middot;
                    <i class="bi bi-calendar-event ms-2 me-1" aria-hidden="true"></i>{{ conta.data|date:"d/m/Y" }}
                  </small>
                </div>
              </div>
            </div>
          {% endif %}
        </div>
      {% endfor %}

      <div class="row">
        <div class="col-12">
          <div class="timeline-month" role="separator" aria-label="{{ grupo.label }}">
            <span class="month-chip" style="width: 200px; height: auto;">
              <i class="bi bi-calendar3 me-1" aria-hidden="true"></i>{{ grupo.label }}
            </span>
          </div>
        </div>
      </div>

    {% endfor %}

  {% else %}
    <div class="text-center py-5">
      <div class="glass-card p-5 mx-auto" style="max-width: 500px;">
        <i class="bi bi-inbox display-1 text-muted mb-3"></i>
        <h3 class="text-muted">Nenhuma conta cadastrada</h3>
        <p class="text-muted mb-4">Comece cadastrando sua primeira conta para ver o histórico aqui.</p>
        <a href="{% url 'cadastrar_conta' %}" class="btn btn-primary btn-lg">
          <i class="bi bi-plus-circle me-2"></i> Cadastrar Primeira Conta
        </a>
      </div>
    </div>
  {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function () {
  const descs = document.querySelectorAll('.js-desc');
  const dateRegex = /^(?:\d{1,2}\/\d{1,2}\/\d{2,4}|(?:\d{1,2}\s+de\s+[A-Za-zÀ-ÿ]+(?:\s+de)?\s+\d{4}))/i;

  descs.forEach(wrapper => {
    const existingList = wrapper.querySelector('ul, ol');
    if (existingList) {
      const ul = document.createElement('ul');
      ul.className = 'timeline-list';
      ul.setAttribute('role', 'list');
      existingList.querySelectorAll('li').forEach(li0 => {
        const li = document.createElement('li');
        li.innerHTML = li0.innerHTML;
        ul.appendChild(li);
      });
      wrapper.replaceWith(ul);
      return;
    }

    const html = wrapper.innerHTML
      .replace(/<br\s*\/?>/gi, '\n')
      .replace(/<\/p>\s*<p>/gi, '\n');
    const temp = document.createElement('div');
    temp.innerHTML = html;
    const rawText = (temp.textContent || temp.innerText || '').trim();
    if (!rawText) { wrapper.remove(); return; }

    const normalized = rawText.replace(/[ \t]+/g, ' ');
    let parts = normalized
      .split(/\s*(?:\n+|[.;]|[•\-—–]|\*\s*)\s*/g)
      .map(s => s.trim())
      .filter(Boolean);

    if (parts.length <= 1) return;

    const ul = document.createElement('ul');
    ul.className = 'timeline-list';
    ul.setAttribute('role', 'list');

    parts.forEach(item => {
      const li = document.createElement('li');
      const m = item.match(dateRegex);
      if (m) {
        const dateSpan = document.createElement('strong');
        dateSpan.className = 'date';
        dateSpan.textContent = m[0];
        li.appendChild(dateSpan);
        const rest = item.slice(m[0].length).replace(/^[\s:\-–—,]+/, ' ');
        if (rest) li.appendChild(document.createTextNode(': ' + rest));
      } else {
        li.appendChild(document.createTextNode(item));
      }
      ul.appendChild(li);
    });

    wrapper.replaceWith(ul);
  });
});
</script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const rows = document.querySelectorAll('.timeline-row');
  const observer = new IntersectionObserver((entries) => {
    entries.forEach(entry => {
      if (entry.isIntersecting) {
        entry.target.classList.add('is-visible');
        observer.unobserve(entry.target);
      }
    });
  }, { threshold: 0.2 });

  rows.forEach(row => observer.observe(row));
});
</script>
{% endblock %}
