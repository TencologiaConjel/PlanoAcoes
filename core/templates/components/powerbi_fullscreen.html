{# PARCIAL ISOLADA: não altera estilos globais #}
<div class="pbiX-root" id="pbiX-root-{{ id|default:'main' }}">
  <div class="pbiX-head">
    <h1 class="pbiX-title">{{ title|default:"Dashboard Financeiro" }}</h1>
    <div class="pbiX-actions">
      {% if back_url %}<a class="pbiX-btn pbiX-btn--ghost" href="{{ back_url }}">← Voltar</a>{% endif %}
      <button class="pbiX-btn" type="button" data-pbix-fs>⛶ Tela cheia</button>
    </div>
  </div>

  <div class="pbiX-card">
    <div class="pbiX-area" data-pbix-area>
      <div class="pbiX-loading" data-pbix-loading>
        <div class="pbiX-spinner"></div>
        <div class="pbiX-muted">Carregando dashboard…</div>
      </div>

      {% if powerbi_url %}
      <iframe
        class="pbiX-frame"
        src="{{ powerbi_url }}"
        title="{{ title|default:'Power BI' }}"
        allow="fullscreen; clipboard-write; encrypted-media"
        allowfullscreen
        loading="lazy"
        data-pbix-frame
      ></iframe>
      {% else %}
      <div class="pbiX-empty">
        <strong>URL do Power BI não configurada.</strong><br/>
        Informe <code>powerbi_url</code> ao incluir o componente.
      </div>
      {% endif %}
    </div>
  </div>
</div>

<style>
/* ======== pbiX (namespaced) — não vaza pro base ======== */
.pbiX-root{--pbiX-max:1280px; --pbiX-gap:12px; --pbiX-radius:12px; --pbiX-shadow:0 6px 20px rgba(0,0,0,.08)}
.pbiX-head{display:flex;align-items:center;gap:12px;justify-content:space-between;max-width:var(--pbiX-max);margin:8px auto 10px;padding:0 8px}
.pbiX-title{margin:0;font-weight:700;font-size:clamp(1.15rem,2.2vw,1.6rem);color:#223}
.pbiX-actions{display:flex;gap:8px}
.pbiX-btn{border:0;border-radius:10px;padding:8px 12px;background:#2f5bb3;color:#fff;cursor:pointer;box-shadow:0 2px 8px rgba(0,0,0,.15)}
.pbiX-btn--ghost{background:transparent;color:#2f5bb3;border:1px solid #2f5bb3}
.pbiX-btn:hover{filter:brightness(.95)}
.pbiX-card{max-width:var(--pbiX-max);margin:0 auto;padding:0 8px}
.pbiX-area{position:relative;height:clamp(520px,78vh,92vh);background:#fff;border:1px solid rgba(0,0,0,.06);border-radius:var(--pbiX-radius);box-shadow:var(--pbiX-shadow);overflow:hidden}
.pbiX-frame{position:absolute;inset:0;width:100%;height:100%;border:0;display:block;background:#f6f7fb}
.pbiX-loading{position:absolute;inset:0;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:10px;background:linear-gradient(180deg,rgba(255,255,255,.85),rgba(255,255,255,.9));z-index:2}
.pbiX-spinner{width:42px;height:42px;border:4px solid #e6ebf5;border-top:4px solid #2f5bb3;border-radius:50%;animation:pbiX-spin 1s linear infinite}
.pbiX-muted{color:#6b7280;font-size:.95rem}
.pbiX-empty{display:grid;place-items:center;min-height:360px;color:#6b7280;padding:24px;text-align:center}
@keyframes pbiX-spin{to{transform:rotate(360deg)}}
/* fullscreen nativo: só cresce a área, não mexe no base */
:fullscreen .pbiX-area{height:100vh}
@media (max-width:768px){
  .pbiX-head{padding:0 6px}
  .pbiX-title{font-size:1.1rem}
  .pbiX-area{height:70vh}
}
</style>

<script>
(function(){
  const root  = document.currentScript.closest('.pbiX-root') || document.querySelector('.pbiX-root')
  const area  = root.querySelector('[data-pbix-area]')
  const btnFS = root.querySelector('[data-pbix-fs]')
  const frame = root.querySelector('[data-pbix-frame]')
  const wait  = root.querySelector('[data-pbix-loading]')

  if(frame){
    frame.addEventListener('load', ()=>{ wait && (wait.style.display='none') })
    // segurança: se o onload não disparar, some com o loader
    setTimeout(()=>{ wait && (wait.style.display='none') }, 6000)
  }

  async function toggleFS(){
    try{
      if(!document.fullscreenElement){
        await area.requestFullscreen()
        btnFS.textContent = '↩ Sair'
      }else{
        await document.exitFullscreen()
        btnFS.textContent = '⛶ Tela cheia'
      }
    }catch(e){
      // fallback: se o navegador bloquear, apenas alterna altura ocupando viewport
      area.style.height = area.style.height.includes('100vh') ? '78vh' : '100vh'
    }
  }
  btnFS && btnFS.addEventListener('click', toggleFS)
  document.addEventListener('fullscreenchange', ()=>{
    btnFS.textContent = document.fullscreenElement ? '↩ Sair' : '⛶ Tela cheia'
  })
})();
</script>
